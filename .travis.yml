language: go
dist: xenial
sudo: true
services:
  - docker
env:
  matrix:
    - GO111MODULE=on
matrix:
  # allow_failures:
  #   - os: windows
  include:
    - os: linux
      go: 1.13.x
      cache:
        directories:
          - "/home/travis/.cache/go-build" # GOCACHE
    - os: osx
      go: 1.13.x
      cache:
        directories:
          - "/Users/travis/Library/Caches/go-build" # GOCACHE
before_install:
  # Setup directory for binaries
  - mkdir ./bin
  - export PATH=$PATH:$PWD/bin
  # Misspell
  - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then wget -O misspell.tar.gz https://github.com/client9/misspell/releases/download/v0.3.4/misspell_0.3.4_linux_64bit.tar.gz; fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then wget -O misspell.tar.gz https://github.com/client9/misspell/releases/download/v0.3.4/misspell_0.3.4_mac_64bit.tar.gz; fi
  - tar xf misspell.tar.gz && cp ./misspell ./bin/misspell
  # staticcheck
  - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then wget -O staticcheck.tar.gz https://github.com/dominikh/go-tools/releases/download/2019.2.2/staticcheck_linux_amd64.tar.gz; fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then wget -O staticcheck.tar.gz https://github.com/dominikh/go-tools/releases/download/2019.2.2/staticcheck_darwin_amd64.tar.gz; fi
  - tar xf staticcheck.tar.gz && cp ./staticcheck/staticcheck ./bin/staticcheck
  # nancy (vulnerable dependencies)
  - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then curl -L -o ./bin/nancy https://github.com/sonatype-nexus-community/nancy/releases/download/v0.1.0/nancy-linux.amd64-v0.1.0; fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then curl -L -o ./bin/nancy https://github.com/sonatype-nexus-community/nancy/releases/download/v0.1.0/nancy-darwin.amd64-v0.1.0; fi
  - if [[ "$TRAVIS_OS_NAME" != "windows" ]]; then chmod +x ./bin/nancy; fi
  # golangci-lint
  - wget -O - -q https://install.goreleaser.com/github.com/golangci/golangci-lint.sh | sh -s v1.23.6
  # gocyclo
  - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then wget -O ./bin/gocyclo https://github.com/adamdecaf/gocyclo/releases/download/2019-08-09/gocyclo-linux-amd64; fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then wget -O ./bin/gocyclo https://github.com/adamdecaf/gocyclo/releases/download/2019-08-09/gocyclo-darwin-amd64; fi
  - chmod +x ./bin/gocyclo
  # mingw (gnu libraries)
  - if [[ "$TRAVIS_OS_NAME" == "windows" ]]; then choco install -y mingw; export PATH=/c/tools/mingw64/bin:"$PATH";fi

before_script:
  - GOFILES=$(find . -type f -name '*.go' | grep -v vendor | grep -v client)
  - go mod graph

script:
  # Just check gofmt on linux, it's the fastest builder
  - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then test -z $(gofmt -s -l $GOFILES); fi
  - go test ./... -race -coverprofile=coverage.txt -covermode=atomic
  - misspell -error -locale US $GOFILES
  - gocyclo -over 31 $GOFILES
  - ./bin/golangci-lint run --skip-dirs="(admin|client)" --timeout=2m --disable=errcheck
  - staticcheck ./cmd/*/*.go *.go
  - if [[ "$TRAVIS_OS_NAME" != "windows" ]]; then go list -m all | ./bin/nancy; fi

after_success:
  - bash <(curl -s https://codecov.io/bash)
  - make
  - make client
  - make docker

before_deploy:
  - make dist

deploy:
  provider: releases
  api_key:
    secure: F019439LyMN7uT/PH6rSI/RGuLZxvqLfTYtJhnKwf4F7VZJMam+1PudDsA9phHxSSVuxXY7vbX76HT+OMLmTKxL9zIlO8QX7GGNOiySWqlxM6RLDzu9qZKY4Tt/XIq+N5bJ0/hEceRH+O0xicDfuhn9c0qtTiC2Q+QuAX8vHCaVUUexQqBHtDz+qizyVfFzdpTdY4v+X98IH5b4/0V+GAWJgBK8kmNOmCzI92YwOJWrGxNSpC7090YXbEJli6SaKatQohfQmiYCRiqyKe+RR012geczRW4wk8D9tux5M34KhU8gz46k3cL7YOCnAW6oO3CSUK2XfVQatOZ9vo24iJ8SUuGGzZzK+0KsUYgsXxi870eZ3FJkdgMS8E8TQ6tfpSpQMXTe9L39i9IVRtPm/aOMu8t6+0Xtz1h2A0V+KoxUx4W5K1VjPQkIrYjDLuND4m0SkJATyNkISCLy9alWVVWi2btIjrtrcLk4wksFKS/ECZFGkYgWZDzJw7UUh6WdivqLbOsGA+22pVhCsfb0zueAO4CLRkFrRdrQupmwErL7wblvNWtyn5/iBOrsr8rpd9c+A75zxAC6KBPluBJdUlJLGjjao3pJnFOMEy8dy83EfD2N5mHpe6j27zaVtGD1X+kkhMPjiiRbwK47vxxmcGIx0+5L43vK6utJEa3JQoVY=
  file_glob: true
  file:
    - bin/accounts-*
  on:
    repo: moov-io/accounts
    tags: true
    go: 1.13.x
  skip_cleanup: true

after_deploy:
  - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
  - make release-push

notifications:
  slack:
    secure: X6l/0euadWaj4/qxOpPGV3+hCOzvKLE0sUQvTnMVx8eOXhlWYxLYskfEpEYnjLomZpzIgvnXID/BTF4GC3WnNHZ7F0xDB1LrmoqfBhI88Ao3DcPRSrl75qJhtS6O2GlT7dAEqrXqU43zOoiXA/aAVr597fmGDvDEFjoHE5u9A8EH9XiNaUTuBZjgF5DzzZlU46i3u23N7HvMmq7iM5K+EJ0nFrCo66ze6XE4sQHZ7huJzPFtJtsAZ2IR5S5yO0fZ4AuJKPfWCEvFaqsp8DAE5n4jB6ZqQH2YL7ujECgoSj3XLoBeGKwET3wtqMmbLB9oxTnpzuEQZBTVlAMi4Ooro0HnbypziZmAk1pZWnQJTFSFS3ArPJph5togB1b1KAxRMDXTKyBHPMR/COPrmWk6ESGnzILvazHy4XY5Viq3qdBFQKtBQ23gt00z17ji99cQkVL0gZTVT0Ue4fY1Gi7fd5Zen7/kef5P1H1ej5J1YXqY5ADKx+SCzMwqy1Pss9ekJ1HsEpTAqMmf+xtOGNqBsZX99yCkSG9BhWYYFxjAetYmoyazT7E5I6qg/rj9hMxcLaG4nFgEm8DKwoMIyxV2cl0skD1MdH8gMZqvvT5MD1qT9EwZySnDQr7Fo34eWVa51ESX007x1XYXyVsQNe/KX5tcuy5+2YjeT1LY2jsodps=
